name: Java CI/CD with Docker

on:
  push:
    branches: ["**"]

jobs:
  # ğŸ”¹ Job 1: Lint
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - run: mvn checkstyle:check

  # ğŸ”¹ Job 2: Tests + Coverage (â‰¥90%)
  test:
    name: ğŸ§ª Tests + Coverage
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - run: mvn -B clean verify

  # ğŸ”¹ Job 3: Build
  build:
    name: ğŸ“¦ Build JAR
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - run: mvn -B package -DskipTests
      - uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  # ğŸ”¹ Job 4: Docker SIMPLIFICADO
  docker:
    name: ğŸ³ Docker Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¥ Install Maven manually (force install)
        run: |
          # Forzar instalaciÃ³n de Maven en el contenedor
          sudo apt-get update
          sudo apt-get install -y maven
          mvn -version

      - name: ğŸ—ï¸ Build with Maven inside container
        run: |
          # Compilar dentro del contenedor para demostrar que funciona
          mvn clean package -DskipTests
          ls -la target/
          echo "âœ… Build successful inside container environment"

      - name: ğŸ”¨ Build Docker image
        run: |
          docker build -t mini-banco:latest .
          echo "âœ… Docker image built"

      - name: ğŸ§ª Test Docker container (SIMPLIFIED)
        run: |
          # Ejecutar y verificar que el contenedor inicia correctamente
          echo "ğŸš€ Starting container..."
          docker run --rm --name test-container mini-banco:latest &
          CONTAINER_PID=$!
          
          # Esperar un poco y verificar que el proceso Java estÃ¡ corriendo
          sleep 5
          
          if docker ps | grep -q "test-container"; then
            echo "âœ… Container is running"
            echo "ğŸ“ Container logs:"
            docker logs test-container || true
          else
            echo "âŒ Container failed to start"
            exit 1
          fi
          
          # Limpiar
          docker stop test-container || true