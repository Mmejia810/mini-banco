name: Java CI/CD with Docker

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ğŸ”¹ Job 1: Lint
  lint:
    name: ğŸ” Lint (Checkstyle)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: ğŸ“¦ Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn --version

      - name: ğŸ” Run Checkstyle
        run: mvn checkstyle:check

  # ğŸ”¹ Job 2: Tests + Coverage (â‰¥90%)
  test:
    name: ğŸ§ª Tests + Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: ğŸ“¦ Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn --version

      - name: ğŸ§ª Run Tests with Coverage
        run: mvn clean verify

      - name: ğŸ“Š Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

      - name: ğŸ“ˆ Coverage Summary
        run: |
          if [ -f target/site/jacoco/index.html ]; then
            echo "âœ… Coverage report generated successfully"
            echo "ğŸ“Š Check coverage in artifacts"
          else
            echo "âŒ Coverage report not found"
            exit 1
          fi

  # ğŸ”¹ Job 3: Build
  build:
    name: ğŸ“¦ Build JAR
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: ğŸ“¦ Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn --version

      - name: ğŸ“¦ Build JAR
        run: mvn clean package -DskipTests

      - name: ğŸ“¤ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  # ğŸ”¹ Job 4: Docker
  docker:
    name: ğŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: [test]
    if: success()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: ğŸ“¦ Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn --version

      - name: ğŸ“¦ Build JAR for Docker
        run: mvn clean package -DskipTests

      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t mini-banco:latest .
          echo "âœ… Docker image built successfully"

      - name: ğŸ§ª Test Docker Container
        run: |
          echo "ğŸš€ Testing Docker container..."
          
          # Ejecutar contenedor en background
          docker run -d --name test-container -p 8080:8080 mini-banco:latest
          
          # Esperar que el contenedor inicie
          echo "â³ Waiting for container to start..."
          sleep 10
          
          # Verificar que el contenedor estÃ¡ corriendo
          if docker ps | grep -q "test-container"; then
            echo "âœ… Container is running successfully"
          
            # Mostrar logs del contenedor
            echo "ğŸ“ Container logs:"
            docker logs test-container
          
          else
            echo "âŒ Container failed to start"
            docker logs test-container
            exit 1
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

  # ğŸ”¹ Job 5: Deploy Info
  deploy-info:
    name: ğŸš€ Deploy Info
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: success()
    steps:
      - name: ğŸ‰ Deployment Ready
        run: |
          echo "ğŸ‰ All checks passed!"
          echo "âœ… Linting: OK"
          echo "âœ… Tests: OK (Coverage â‰¥90%)"
          echo "âœ… Build: OK"
          echo "âœ… Docker: OK"
          echo "ğŸš€ Application is ready for deployment!"